<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Auditfy • Account</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0e13; --bg-elev:#121621; --line:#2a3242; --fg:#e6e9ef; --fg-weak:#aab1bf;
    --gradA:#5f7cff; --gradB:#9b7cff; --danger:#ff6b6b;
    --menuW: 240px;
  }
  body.theme-light{
    --bg:#f8fafc; --bg-elev:#ffffff; --line:#d7dbe3; --fg:#1c222b; --fg-weak:#556070;
    --gradA:#4d6bff; --gradB:#e77cff; --danger:#e11d48;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif;
    display:flex; flex-direction:column; height:100vh; overflow:hidden;
  }
  .topbar{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
    gap:12px; padding:10px 18px; background:var(--bg-elev); border-bottom:1px solid var(--line);
  }
  .brand{ display:flex; align-items:center; gap:10px; user-select:none }
  .brand .logoLink{ display:flex; align-items:center; color:var(--fg); text-decoration:none; }
  .brand .logoLink:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius:8px; }
  .brand .logo{ font-family:'Montserrat',system-ui; font-weight:800; font-size:20px; letter-spacing:.3px; }
  .brand .chip{ font-size:11px; color:var(--fg-weak); border:1px solid var(--line); padding:2px 6px; border-radius:999px }
  .centerTitle{ display:flex; justify-content:center; align-items:center; gap:10px; }
  #pageTitle{ font-weight:700; }
  .rightBtns{ display:flex; gap:10px; justify-content:flex-end; align-items:center; }
  .navBtn{ display:flex; align-items:center; gap:8px; padding:6px 12px; border-radius:12px; border:1px solid var(--line); background:var(--bg); color:var(--fg); text-decoration:none; transition:.15s; }
  .navBtn svg{ width:20px; height:20px; stroke:var(--fg); stroke-width:1.6; fill:none; }
  .navBtn:hover{ border-color:var(--gradA); background:linear-gradient(120deg,var(--gradA),var(--gradB)); color:#fff; }

  .main{ flex:1; display:grid; grid-template-columns:minmax(0,1fr) var(--menuW); min-height:0; }
  .content{ padding:18px 22px; overflow:auto; }
  .menuRail{ border-left:1px solid var(--line); background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.03)); padding:14px 10px; display:flex; flex-direction:column; gap:10px; }
  .menuLabel{ font-size:12px; font-weight:600; color:var(--fg-weak); padding:0 6px; }
  .menuBtn{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:12px; cursor:pointer; border:1px solid transparent; background:transparent; color:var(--fg); font:inherit; text-align:left; transition:.15s; }
  .menuBtn svg{ width:22px; height:22px; stroke:var(--fg); stroke-width:1.7; fill:none; }
  .menuBtn span{ font-weight:600; }
  .menuBtn.on{ background:linear-gradient(120deg,var(--gradA),var(--gradB)); color:#fff; border-color:transparent; box-shadow:0 12px 28px rgba(0,0,0,0.25); }
  .menuBtn.on svg{ stroke:#fff; }

  .panel{ display:none; animation:fade .18s ease; }
  .panel.active{ display:block; }
  @keyframes fade{ from{ opacity:0; transform:translateY(8px);} to{ opacity:1; transform:none; } }

  .panelHeader{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
  .panelHeader h2{ margin:0; font-size:20px; }

  .card{ border:1px solid var(--line); border-radius:16px; background:var(--bg-elev); padding:18px; box-shadow:0 12px 34px rgba(0,0,0,0.26); margin-bottom:18px; }
  .cardHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:16px; }
  .cardHeader h3{ margin:0; font-size:18px; }
  .muted{ color:var(--fg-weak); }

  .usageGrid{ display:grid; gap:18px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
  .ringCard{ display:flex; flex-direction:column; align-items:center; gap:12px; text-align:center; padding:20px; }
  .ringTitle{ font-weight:600; }
  .usageRing{ width:150px; height:150px; border-radius:50%; position:relative; background:conic-gradient(var(--gradA) calc(var(--progress,0)*360deg), rgba(255,255,255,0.08) 0); display:flex; align-items:center; justify-content:center; transition:.3s; }
  .usageRing::after{ content:''; position:absolute; inset:18px; border-radius:50%; background:var(--bg); box-shadow:inset 0 0 0 1px var(--line); }
  .usageRingInner{ position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; gap:2px; }
  .usageRingValue{ font-size:24px; font-weight:700; }
  .usageRingHint{ font-size:12px; color:var(--fg-weak); }
  .usageDetail{ font-weight:600; }
  .usageCaption{ font-size:12px; color:var(--fg-weak); }

  .formGrid{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .formField{ display:flex; flex-direction:column; gap:6px; }
  label{ font-size:13px; font-weight:600; color:var(--fg-weak); }
  .in{ padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:var(--bg); color:var(--fg); font:inherit; }
  .in[disabled]{ opacity:0.6; cursor:not-allowed; }
  .buttonRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:var(--bg); color:var(--fg); cursor:pointer; font-weight:600; transition:.15s; }
  .btn.grad{ background:linear-gradient(120deg,var(--gradA),var(--gradB)); border-color:transparent; color:#fff; box-shadow:0 8px 22px rgba(0,0,0,0.25); }
  .btn.danger{ border-color:var(--danger); color:var(--danger); }
  .btn:disabled{ opacity:0.6; cursor:not-allowed; box-shadow:none; }

  .dangerZone{ margin-top:16px; border:1px dashed var(--danger); border-radius:12px; padding:16px; background:rgba(255,107,107,0.08); }
  .dangerZone h4{ margin:0 0 6px 0; font-size:15px; }

  .billingHero{ background:linear-gradient(120deg,rgba(95,124,255,0.28),rgba(155,124,255,0.16)); border-color:rgba(95,124,255,0.35); box-shadow:none; }
  .billingHero h3{ font-size:22px; margin:0 0 8px 0; }

  .pricingGrid{ display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
  .planCard{ border:1px solid var(--line); border-radius:16px; background:var(--bg); padding:18px; display:flex; flex-direction:column; gap:10px; box-shadow:0 8px 24px rgba(0,0,0,0.2); }
  .planCard h4{ margin:0; font-size:17px; }
  .priceTag{ font-size:20px; font-weight:700; }
  .priceSub{ font-size:12px; color:var(--fg-weak); }
  .planCard ul{ margin:0; padding-left:18px; display:grid; gap:6px; font-size:13px; }
  .featureList{ margin:0; padding-left:18px; display:grid; gap:6px; font-size:13px; }

  .planCompare{ border-top:1px dashed var(--line); padding-top:14px; margin-top:10px; display:grid; gap:10px; font-size:13px; }
  .planCompareRow{ display:flex; flex-wrap:wrap; gap:10px; }
  .planCompareRow strong{ min-width:120px; color:var(--fg-weak); }
  .planCompareValues{ display:flex; flex-wrap:wrap; gap:12px; }
  .announceBanner{ border:1px solid var(--line); border-radius:14px; background:linear-gradient(120deg,rgba(95,124,255,0.18),rgba(155,124,255,0.12)); padding:14px 16px; display:flex; flex-direction:column; gap:8px; margin-bottom:18px; position:relative; }
  .announceBanner.hidden{ display:none; }
  .announceBanner h4{ margin:0; font-size:16px; }
  .announceBanner p{ margin:0; font-size:13px; color:var(--fg); }
  .announceBanner .bannerActions{ display:flex; gap:10px; flex-wrap:wrap; }
  .announceBanner .bannerActions .btn{ padding:8px 12px; }
  .announceBannerClose{ position:absolute; top:10px; right:10px; border:none; background:transparent; color:var(--fg-weak); cursor:pointer; font-size:18px; line-height:1; }
  .hidden{ display:none !important; }

  .giftCodeSection{ display:flex; flex-direction:column; gap:8px; }
  .giftCodeStatus{ font-size:12px; color:var(--fg-weak); }

  .themePreview{ margin-top:20px; border:1px solid var(--line); border-radius:16px; overflow:hidden; background:var(--bg); box-shadow:0 12px 30px rgba(0,0,0,0.25); transition:.2s; }
  .themePreview .previewTop{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:var(--bg-elev); border-bottom:1px solid var(--line); }
  .themePreview .previewLogo{ font-family:'Montserrat',system-ui; font-weight:700; }
  .themePreview .previewBtn{ padding:6px 10px; border-radius:10px; border:1px solid var(--line); font-size:11px; }
  .themePreview .previewBody{ display:flex; }
  .themePreview .previewSidebar{ width:110px; border-right:1px solid var(--line); padding:12px; display:grid; gap:8px; font-size:11px; }
  .themePreview .previewSidebar div{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.06); }
  .themePreview .previewMain{ flex:1; padding:18px; display:grid; gap:10px; font-size:12px; }
  .themePreview[data-theme="light"]{ background:#f8fafc; border-color:#d7dbe3; box-shadow:0 12px 26px rgba(0,0,0,0.12); }
  .themePreview[data-theme="light"] .previewTop{ background:#ffffff; border-color:#d7dbe3; color:#1c222b; }
  .themePreview[data-theme="light"] .previewSidebar div{ background:rgba(77,107,255,0.12); color:#1c222b; }
  .themePreview[data-theme="light"] .previewBtn{ border-color:#d7dbe3; }

  .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:220; padding:20px; }
  .modal.open{ display:flex; }
  .modalCard{ background:var(--bg-elev); border:1px solid var(--line); border-radius:18px; width:min(560px,96vw); padding:22px; box-shadow:0 22px 48px rgba(0,0,0,0.38); display:flex; flex-direction:column; gap:18px; }
  .modalHeader{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .modalHeader h3{ margin:0; font-size:18px; }
  .modalClose{ border:none; background:transparent; color:var(--fg-weak); cursor:pointer; font-size:20px; line-height:1; }
  .stepIndicator{ font-size:12px; font-weight:600; color:var(--fg-weak); }
  .subStep{ display:none; }
  .subStep.active{ display:block; }
  .chipBtn{ padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:var(--bg); color:var(--fg); cursor:pointer; font-size:13px; transition:.15s; }
  .chipBtn.on{ background:linear-gradient(120deg,var(--gradA),var(--gradB)); color:#fff; border-color:transparent; box-shadow:0 8px 18px rgba(0,0,0,0.24); }
  .methodGrid{ display:grid; gap:12px; }
  .methodCard{ border:1px solid var(--line); border-radius:14px; padding:12px; display:flex; gap:12px; align-items:center; cursor:pointer; transition:.15s; }
  .methodCard.on{ border-color:var(--gradA); background:rgba(95,124,255,0.16); }
  .methodIcon{ width:36px; height:36px; border-radius:50%; background:rgba(95,124,255,0.18); display:grid; place-items:center; }
  .methodIcon svg{ width:20px; height:20px; stroke:var(--gradA); stroke-width:1.6; fill:none; }
  .methodBody{ display:flex; flex-direction:column; gap:4px; }
  .instructionBox{ border:1px dashed var(--line); border-radius:12px; padding:12px; font-size:13px; background:rgba(255,255,255,0.02); }
  .subscribeNav{ display:flex; justify-content:space-between; gap:10px; }
  .subscribeNav .btn{ flex:1; justify-content:center; }
  .subscribeNav .btn.hidden{ display:none; }

  .bottombar{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-top:1px solid var(--line); background:var(--bg-elev); color:var(--fg-weak); font-size:12px; }

  #snack{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(12px); background:var(--bg-elev); border:1px solid var(--line); padding:10px 14px; border-radius:12px; opacity:0; transition:.2s; z-index:260; box-shadow:0 14px 34px rgba(0,0,0,0.32); }
  #snack.show{ opacity:1; transform:translateX(-50%) }

  @media (max-width:1024px){
    .main{ grid-template-columns:1fr; }
    .menuRail{ position:sticky; bottom:0; top:auto; flex-direction:row; overflow-x:auto; border-left:none; border-top:1px solid var(--line); background:var(--bg-elev); }
    .menuBtn{ flex:1; justify-content:center; }
    .menuBtn span{ display:none; }
  }
</style>
</head>
<body class="theme-dark">
  <div class="topbar">
    <div class="brand"><a class="logoLink" href="/projects.html" title="프로젝트로 이동"><span class="logo">Auditfy</span></a><div class="chip">alpha</div></div>
    <div class="centerTitle"><div id="pageTitle">대시보드</div></div>
    <div class="rightBtns">
      <a class="navBtn" href="/projects.html" title="프로젝트">
        <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        <span>프로젝트</span>
      </a>
      <a class="navBtn" href="/index.html" title="에디터">
        <svg viewBox="0 0 24 24"><path d="M4 4h8v8H4zM12 12h8v8h-8z"/></svg>
        <span>에디터</span>
      </a>
    </div>
  </div>

  <div class="main">
    <div class="content" id="panelWrap">
      <div id="announcementBanner" class="announceBanner hidden">
        <button class="announceBannerClose" id="announcementDismiss" aria-label="닫기">×</button>
        <h4 id="announcementBannerTitle">공지 제목</h4>
        <p id="announcementBannerBody">공지 내용</p>
        <div class="bannerActions">
          <a class="btn" id="announcementDetailBtn" href="/announcements.html" target="_blank" rel="noopener">자세히 보기</a>
          <button class="btn" id="announcementDismissBtn">다시 보지 않기</button>
        </div>
      </div>

      <section class="panel active" data-panel="dashboard">
        <div class="panelHeader"><h2>대시보드</h2></div>
        <div class="card" id="planCard">
          <div class="cardHeader">
            <div>
              <div class="muted" style="font-size:12px">현재 플랜</div>
              <h3 id="planName">-</h3>
            </div>
            <div style="text-align:right">
              <div class="priceTag" id="planPrice">-</div>
              <div class="priceSub" id="planPriceSub"></div>
              <div class="muted" id="planExpiry" style="margin-top:4px"></div>
            </div>
          </div>
          <p class="muted" id="planDescription" style="margin:12px 0 0 0"></p>
          <ul class="featureList" id="planPerks" style="margin-top:16px; padding-left:18px; display:grid; gap:6px;"></ul>
          <div class="buttonRow" style="margin-top:16px">
            <button class="btn" id="refreshUsageBtn">용량 새로고침</button>
            <button class="btn" id="viewPlansBtn">업그레이드 살펴보기</button>
          </div>
        </div>

        <div class="usageGrid">
          <div class="ringCard">
            <div class="ringTitle">프로젝트 저장소</div>
            <div class="usageRing" id="projUsageRing" style="--progress:0">
              <div class="usageRingInner">
                <div class="usageRingValue" id="projUsageValue">0%</div>
                <div class="usageRingHint">사용됨</div>
              </div>
            </div>
            <div class="usageDetail" id="projUsageLabel">-</div>
            <div class="usageCaption" id="projUsageCaption">-</div>
          </div>
          <div class="ringCard">
            <div class="ringTitle">Auditfy Cloud</div>
            <div class="usageRing" id="cloudUsageRing" style="--progress:0">
              <div class="usageRingInner">
                <div class="usageRingValue" id="cloudUsageValue">0%</div>
                <div class="usageRingHint">사용됨</div>
              </div>
            </div>
            <div class="usageDetail" id="cloudUsageLabel">-</div>
            <div class="usageCaption" id="cloudUsageCaption">-</div>
          </div>
        </div>
      </section>

      <section class="panel" data-panel="account">
        <div class="panelHeader"><h2>계정 및 보안</h2></div>
        <div class="card">
          <div class="formGrid">
            <div class="formField">
              <label for="accountEmail">이메일</label>
              <input id="accountEmail" class="in" type="email" disabled />
            </div>
            <div class="formField">
              <label for="accountName">이름</label>
              <div class="buttonRow">
                <input id="accountName" class="in" type="text" placeholder="이름" />
                <button class="btn grad" id="saveNameBtn">저장</button>
              </div>
            </div>
          </div>

          <div class="divider" style="height:1px; background:var(--line); margin:20px 0;"></div>

          <div class="formGrid">
            <div class="formField">
              <label>플랜 변경</label>
              <p class="muted" style="margin:0">플랜 업그레이드는 결제 확인 후 슈퍼관리자가 적용합니다. 결제 패널에서 신청하거나 기프트 코드를 적용해 주세요.</p>
            </div>
            <div class="formField">
              <label>비밀번호</label>
              <p class="muted" style="margin:0 0 8px 0">등록된 이메일로 임시 비밀번호를 발급합니다.</p>
              <button class="btn" id="resetPasswordBtn">재설정 메일 보내기</button>
              <p class="muted" style="margin:8px 0 0 0; font-size:12px;">임시 비밀번호가 오랜 시간 도착하지 않는다면 <a href="mailto:yoon080708@gmail.com" style="color:inherit;text-decoration:underline;">yoon080708@gmail.com</a> 으로 연락해 주세요. 최대한 빠르게 도와드릴게요.</p>
            </div>
          </div>

          <div class="buttonRow" style="margin-top:16px">
            <button class="btn" id="logoutBtn">로그아웃</button>
          </div>

          <div class="dangerZone">
            <h4>계정 삭제</h4>
            <p class="muted" style="margin:0 0 10px 0">계정을 삭제하면 프로젝트와 Cloud 파일을 포함한 모든 데이터가 영구적으로 제거됩니다. 이 작업은 되돌릴 수 없습니다.</p>
            <button class="btn danger" id="deleteAccountBtn">계정 삭제</button>
          </div>
        </div>
      </section>

      <section class="panel" data-panel="billing">
        <div class="panelHeader"><h2>결제</h2></div>
        <div class="card billingHero">
          <h3>업그레이드하여 경험을 향상하세요</h3>
          <p class="muted">더 넓은 저장 공간과 빠른 지원, 고급 내보내기 옵션으로 제작 효율을 높여 보세요.</p>
        </div>

        <div class="card">
          <div class="cardHeader"><h3>플랜 비교</h3><span class="chip" id="pricingUpdatedAt">-</span></div>
          <div class="pricingGrid" id="billingPlanGrid"></div>
          <div class="planCompare" id="planComparisonTable"></div>
        </div>

        <div class="card">
          <div class="cardHeader"><h3>기프트 코드</h3></div>
          <div class="giftCodeSection">
            <p class="muted" style="margin:0">코드를 적용하면 지정된 기간 동안 플랜이 즉시 업데이트됩니다.</p>
            <div class="buttonRow">
              <input id="giftCodeInput" class="in" placeholder="예: AUD-1A2B3C" style="max-width:220px" />
              <button class="btn" id="giftCodeApplyBtn">코드 적용</button>
            </div>
            <p class="giftCodeStatus" id="giftCodeStatus"></p>
          </div>
        </div>
      </section>

      <section class="panel" data-panel="theme">
        <div class="panelHeader"><h2>테마</h2></div>
        <div class="card">
          <div class="cardHeader"><h3>테마 설정</h3></div>
          <p class="muted">에디터, 프로젝트, 계정 페이지에서 동일한 테마가 적용됩니다.</p>
          <div class="buttonRow" style="margin-top:16px">
            <button class="btn" data-theme="dark" id="themeDarkBtn">다크 모드</button>
            <button class="btn" data-theme="light" id="themeLightBtn">라이트 모드</button>
            <button class="btn" data-theme="auto" id="themeAutoBtn">시스템 연동</button>
          </div>
          <p class="muted" id="themeStatus" style="margin-top:12px"></p>
          <div class="themePreview" id="themePreview" data-theme="dark">
            <div class="previewTop">
              <div class="previewLogo">Auditfy</div>
              <div class="previewBtn">Project.zip</div>
            </div>
            <div class="previewBody">
              <div class="previewSidebar">
                <div>FileHub</div>
                <div>Timeline</div>
                <div>Export</div>
              </div>
              <div class="previewMain">
                <div style="height:12px; background:rgba(255,255,255,0.08); border-radius:6px;"></div>
                <div style="height:80px; border-radius:12px; background:rgba(95,124,255,0.22);"></div>
                <div style="height:12px; background:rgba(255,255,255,0.08); border-radius:6px;"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <aside class="menuRail" id="menuRail">
      <div class="menuLabel">메뉴</div>
      <button class="menuBtn on" data-panel="dashboard">
        <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm10 8h8v-6h-8v6zM3 21h8v-6H3v6zm10-8h8V3h-8v10z"/></svg>
        <span>대시보드</span>
      </button>
      <button class="menuBtn" data-panel="account">
        <svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/><path d="M4 21c0-4 4-7 8-7s8 3 8 7"/></svg>
        <span>계정</span>
      </button>
      <button class="menuBtn" data-panel="billing">
        <svg viewBox="0 0 24 24"><path d="M3 5h18v14H3z"/><path d="M3 10h18"/><path d="M7 15h3"/></svg>
        <span>결제</span>
      </button>
      <button class="menuBtn" data-panel="theme">
        <svg viewBox="0 0 24 24"><path d="M12 3a1 1 0 0 0-1 1v5H6a1 1 0 0 0-1 1v4h5v5a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-5h5a1 1 0 0 0 1-1v-4h-5V4a1 1 0 0 0-1-1h-4Z"/></svg>
        <span>테마</span>
      </button>
      <button class="menuBtn" data-panel="support">
        <svg viewBox="0 0 24 24"><path d="M12 18v-2"/><path d="M6 9a6 6 0 0 1 12 0c0 3-3 4-3 4H9s-3-1-3-4"/><path d="m15 22-3-3-3 3"/></svg>
        <span>지원</span>
      </button>
    </aside>
  </div>

  <div class="bottombar">
    <div>© Auditfy • Account</div>
    <div id="statusText">초기화 중…</div>
  </div>

  <div id="snack">OK</div>

  <div id="subscribeModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modalCard">
      <div class="modalHeader">
        <h3 id="subscribeModalTitle">플랜 구독</h3>
        <button class="modalClose" id="subscribeModalClose" aria-label="닫기">×</button>
      </div>
      <div class="stepIndicator" id="subscribeStepIndicator">1 / 3</div>
      <div class="subStep active" data-step="1">
        <h4 style="margin:0 0 10px 0">1단계 · 결제 주기 선택</h4>
        <p class="muted">선결제 기간을 선택하세요. 12개월 결제 시 2개월이 무료로 제공됩니다.</p>
        <div class="buttonRow" id="billingCycleChips">
          <button class="chipBtn" data-cycle="1">1개월</button>
          <button class="chipBtn" data-cycle="3">3개월</button>
          <button class="chipBtn" data-cycle="6">6개월</button>
          <button class="chipBtn" data-cycle="12">12개월 (2개월 무료)</button>
        </div>
      </div>
      <div class="subStep" data-step="2">
        <h4 style="margin:0 0 10px 0">2단계 · 결제 방법 선택</h4>
        <p class="muted">선호하는 결제 수단을 선택하세요.</p>
        <div class="methodGrid" id="paymentMethodCards">
          <div class="methodCard" data-method="account">
            <div class="methodIcon"><svg viewBox="0 0 24 24"><path d="M3 7h18"/><path d="M3 12h18"/><path d="M6 17h3"/></svg></div>
            <div class="methodBody">
              <strong>국내 계좌이체</strong>
              <span class="muted">은행 앱 또는 인터넷 뱅킹으로 송금</span>
            </div>
          </div>
          <div class="methodCard" data-method="paypal">
            <div class="methodIcon"><svg viewBox="0 0 24 24"><path d="M5 15c.5-4 2-6 6-6h3.5a2.5 2.5 0 0 1 0 5H12"/><path d="M7 19h4"/></svg></div>
            <div class="methodBody">
              <strong>PayPal.Me</strong>
              <span class="muted">글로벌 사용자용 간편 송금</span>
            </div>
          </div>
          <div class="methodCard" data-method="proton">
            <div class="methodIcon"><svg viewBox="0 0 24 24"><path d="M12 3 2 9l10 6 10-6z"/><path d="m2 15 10 6 10-6"/></svg></div>
            <div class="methodBody">
              <strong>Proton Wallet</strong>
              <span class="muted">Email via Bitcoin 기능 사용</span>
            </div>
          </div>
        </div>
      </div>
      <div class="subStep" data-step="3">
        <h4 style="margin:0 0 10px 0">3단계 · 송금 안내</h4>
        <div class="instructionBox" id="subscribeSummary">선택 정보를 정리하는 중…</div>
        <div class="instructionBox" id="subscribeInstructions"></div>
      </div>
      <div class="subscribeNav">
        <button class="btn hidden" id="subscribeBackBtn">이전</button>
        <button class="btn grad" id="subscribeNextBtn">다음</button>
        <button class="btn grad hidden" id="subscribeConfirmBtn">결제 안내 받기</button>
      </div>
    </div>
  </div>

  <div id="deleteReasonModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modalCard" style="max-width:480px;">
      <div class="modalHeader">
        <h3>계정 삭제 전에 알려주세요</h3>
        <button class="modalClose" id="deleteReasonClose" aria-label="닫기">×</button>
      </div>
      <p class="muted">서비스를 개선하는 데 도움이 되도록 이유를 간단히 적어 주세요. 입력하지 않아도 다음 단계로 진행할 수 있습니다.</p>
      <textarea id="deleteReasonInput" class="in" rows="4" placeholder="예: 필요한 기능이 없어요"></textarea>
      <div class="subscribeNav">
        <button class="btn" id="deleteReasonCancelBtn">취소</button>
        <button class="btn grad" id="deleteReasonNextBtn">다음</button>
      </div>
    </div>
  </div>

  <div id="deleteConfirmModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modalCard" style="max-width:520px;">
      <div class="modalHeader">
        <h3>정말 계정을 삭제하시겠어요?</h3>
        <button class="modalClose" id="deleteConfirmClose" aria-label="닫기">×</button>
      </div>
      <div class="instructionBox" id="deleteReasonPreview" style="display:none"></div>
      <p class="muted">계정을 삭제하면 프로젝트, Cloud 파일 등 모든 데이터가 영구적으로 제거됩니다. 한 번 삭제하면 복구할 수 없습니다.</p>
      <div class="instructionBox">혹시 잠깐만 기다려 볼까요? <strong>support@auditfy.app</strong> 으로 연락 주시면 필요한 기능이나 문제 상황을 함께 해결해 드릴 수 있습니다.</div>
      <div class="subscribeNav">
        <button class="btn" id="deleteBackBtn">돌아가기</button>
        <button class="btn" id="deleteLaterBtn">닫기</button>
        <button class="btn danger" id="deleteConfirmBtn">그래도 삭제할게요</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="/cloud.js"></script>
  <script>
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const snack=(t)=>{ const el=$('#snack'); el.textContent=t; el.classList.add('show'); clearTimeout(snack._timer); snack._timer=setTimeout(()=>el.classList.remove('show'),1800); };

    const SUPPORT_URL = 'https://www.notion.so/auditfy-support';

    const PANEL_TITLES = {
      dashboard:'대시보드',
      account:'계정 및 보안',
      billing:'결제',
      theme:'테마',
      support:'지원'
    };

    const FALLBACK_PLANS=[
      { id:'Free', label:'Free', description:'취미 및 테스트 용도에 적합한 무료 플랜', quotas:{ projectBytes:20*1024*1024, cloudBytes:30*1024*1024 }, pricing:{ currency:'KRW', monthly:0, usdMonthly:0 }, perks:['프로젝트 저장소 20MB 제공','Auditfy Cloud 30MB 제공','이메일 지원 (48시간 이내 응답)','기본 내보내기 품질'] },
      { id:'Plus', label:'Plus', description:'크리에이터를 위한 확장 스토리지와 향상된 지원', quotas:{ projectBytes:50*1024*1024, cloudBytes:250*1024*1024 }, pricing:{ currency:'KRW', monthly:9900, usdMonthly:8 }, perks:['프로젝트 저장소 50MB 제공','Auditfy Cloud 250MB 제공','우선 지원 (24시간 이내 응답)','고급 내보내기 프리셋'] },
      { id:'Pro', label:'Pro', description:'스튜디오 및 팀 협업에 최적화된 전문가용 플랜', quotas:{ projectBytes:100*1024*1024, cloudBytes:400*1024*1024 }, pricing:{ currency:'KRW', monthly:19900, usdMonthly:16 }, perks:['프로젝트 저장소 100MB 제공','Auditfy Cloud 400MB 제공','프리미엄 지원 (12시간 이내 응답)','전문가용 마스터링 도구'] }
    ];

    const state={ currentPanel:'dashboard', session:null, usage:{cloudBytes:0,projBytes:0}, plans:FALLBACK_PLANS, catalogUpdatedAt:null, announcements:[] };
    const subscribeState={ step:1, planId:null, cycle:12, method:'account' };
    const deleteState={ reason:'' };
    const BANNER_DISMISS_KEY='auditfy.banner.dismissed';

    const PAYMENT_GUIDES={
      account:`<strong>국내 계좌이체 안내</strong><br>은행: 지역축농협<br>계좌번호: <strong>3521026319633</strong><br>예금주: 윤성민<br>송금 시 참고사항(메모)에 Auditfy 계정 이메일을 입력해 주세요.` ,
      paypal:`<strong>PayPal.Me 송금 안내</strong><br>PayPal 앱 또는 웹에서 <strong>paypal.me/rugguggu</strong> (@rugguggu)로 이동해 금액을 입력하고 송금하세요.<br>결제 메모에 Auditfy 계정 이메일을 남겨주시면 확인이 빠릅니다.` ,
      proton:`<strong>Proton Wallet 안내</strong><br>Proton Wallet에서 Email via Bitcoin 기능을 사용하여 <strong>yoon080708@proton.me</strong>로 송금해주세요.<br>송금 확인 후 수동으로 플랜이 적용됩니다.`
    };

    const sysTheme=window.matchMedia('(prefers-color-scheme: dark)');
    sysTheme.addEventListener?.('change',()=>{ if(getTheme()==='auto') applyThemeFrom('auto'); });

    function applyThemeFrom(value){
      document.body.classList.toggle('theme-light', value==='light' || (value==='auto' && !sysTheme.matches));
      localStorage.setItem('auditfy.theme', value);
      const status=$('#themeStatus');
      if(status) status.textContent=`현재 테마: ${value==='auto'?'시스템 연동':value==='light'?'라이트':'다크'}`;
      updateThemePreview(value);
    }
    function getTheme(){ return localStorage.getItem('auditfy.theme') || 'dark'; }
    function syncThemeButtons(){
      const current=getTheme();
      ['Dark','Light','Auto'].forEach(name=>{
        const btn=$('#theme'+name+'Btn');
        if(btn) btn.classList.toggle('grad', btn.dataset.theme===current);
      });
      const status=$('#themeStatus');
      if(status) status.textContent=`현재 테마: ${current==='auto'?'시스템 연동':current==='light'?'라이트':'다크'}`;
      updateThemePreview(current);
    }
    function setTheme(next){ applyThemeFrom(next); syncThemeButtons(); }

    function updateThemePreview(mode){
      const preview=$('#themePreview');
      if(!preview) return;
      let resolved=mode;
      if(mode==='auto') resolved = sysTheme.matches ? 'dark' : 'light';
      preview.dataset.theme = resolved;
    }

    function formatBytes(bytes){
      if(bytes===Infinity) return '∞';
      if(!Number.isFinite(bytes) || bytes<0) return '-';
      if(bytes < 1024) return `${bytes}B`;
      const units=['KB','MB','GB','TB'];
      let i=-1; let v=bytes;
      do{ v/=1024; i++; }while(v>=1024 && i<units.length-1);
      const fixed = v>=100 || i===0 ? v.toFixed(0) : v.toFixed(1);
      return `${fixed}${units[i]}`;
    }
    function formatCurrencyKRW(value){
      if(value===0) return '무료';
      return `₩${Number(value||0).toLocaleString('ko-KR')} /월`;
    }
    function formatUSD(value){
      if(!value) return '';
      return `$${Number(value).toFixed(0)}/mo`;
    }
    function formatDate(iso){
      if(!iso) return '';
      const d=new Date(iso);
      if(isNaN(d.getTime())) return '';
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function activatePanel(panel){
      state.currentPanel = panel;
      if(panel==='support') return;
      $$('#panelWrap .panel').forEach(sec=> sec.classList.toggle('active', sec.dataset.panel===panel));
      $$('#menuRail .menuBtn').forEach(btn=> btn.classList.toggle('on', btn.dataset.panel===panel));
      $('#pageTitle').textContent = PANEL_TITLES[panel] || 'Account';
    }

    function getCurrentPlan(){
      const id = state.session?.plan || 'Free';
      return state.plans.find(p => (p.id || '').toLowerCase() === String(id).toLowerCase()) || state.plans[0];
    }

    function renderUsage(){
      const plan = getCurrentPlan();
      const projQuota = plan?.quotas?.projectBytes ?? 0;
      const cloudQuota = plan?.quotas?.cloudBytes ?? 0;
      const projRatio = projQuota>0 && Number.isFinite(projQuota) ? Math.min(1, state.usage.projBytes / projQuota) : 0;
      const cloudRatio = cloudQuota>0 && Number.isFinite(cloudQuota) ? Math.min(1, state.usage.cloudBytes / cloudQuota) : 0;

      const projRing=$('#projUsageRing');
      const cloudRing=$('#cloudUsageRing');
      const projVal=$('#projUsageValue');
      const cloudVal=$('#cloudUsageValue');
      const projPct = projQuota>0 && Number.isFinite(projQuota) ? Math.min(100, Math.round(projRatio*100)) : 0;
      const cloudPct = cloudQuota>0 && Number.isFinite(cloudQuota) ? Math.min(100, Math.round(cloudRatio*100)) : 0;
      if(projRing) projRing.style.setProperty('--progress', projQuota>0 && Number.isFinite(projQuota) ? projRatio : 0);
      if(cloudRing) cloudRing.style.setProperty('--progress', cloudQuota>0 && Number.isFinite(cloudQuota) ? cloudRatio : 0);
      if(projVal) projVal.textContent = projQuota>0 && Number.isFinite(projQuota) ? `${projPct}%` : '∞';
      if(cloudVal) cloudVal.textContent = cloudQuota>0 && Number.isFinite(cloudQuota) ? `${cloudPct}%` : '∞';

      $('#projUsageLabel').textContent = `${formatBytes(state.usage.projBytes)} / ${formatBytes(projQuota || Infinity)}`;
      $('#cloudUsageLabel').textContent = `${formatBytes(state.usage.cloudBytes)} / ${formatBytes(cloudQuota || Infinity)}`;

      const remainingProj = projQuota - state.usage.projBytes;
      const remainingCloud = cloudQuota - state.usage.cloudBytes;
      $('#projUsageCaption').textContent = projQuota && Number.isFinite(projQuota)
        ? `${formatBytes(Math.max(0, remainingProj))} 남음`
        : '무제한 저장 공간';
      $('#cloudUsageCaption').textContent = cloudQuota && Number.isFinite(cloudQuota)
        ? `${formatBytes(Math.max(0, remainingCloud))} 남음`
        : '무제한 저장 공간';
    }

    function renderDashboard(){
      const plan = getCurrentPlan();
      $('#planName').textContent = plan?.label || 'Free';
      $('#planDescription').textContent = plan?.description || '';
      $('#planPrice').textContent = formatCurrencyKRW(plan?.pricing?.monthly ?? 0);
      const usd = formatUSD(plan?.pricing?.usdMonthly ?? 0);
      $('#planPriceSub').textContent = usd ? `${usd} · VAT 별도` : 'VAT 별도';
      const expiry = formatDate(state.session?.planExpiresAt);
      $('#planExpiry').textContent = expiry ? `만료 예정일: ${expiry}` : '만료 예정일이 설정되지 않았습니다.';
      const perks = plan?.perks || [];
      const list = $('#planPerks');
      if(list) list.innerHTML = perks.map(text=>`<li>${text}</li>`).join('');
      renderUsage();
    }

    function isBannerDismissed(id){
      if(!id) return false;
      try{
        const raw = localStorage.getItem(BANNER_DISMISS_KEY);
        if(!raw) return false;
        const arr = JSON.parse(raw);
        return Array.isArray(arr) && arr.includes(id);
      }catch{ return false; }
    }

    function dismissBanner(id){
      if(!id) return;
      try{
        const raw = localStorage.getItem(BANNER_DISMISS_KEY);
        const arr = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : [];
        if(!arr.includes(id)) arr.push(id);
        localStorage.setItem(BANNER_DISMISS_KEY, JSON.stringify(arr));
      }catch{
        localStorage.setItem(BANNER_DISMISS_KEY, JSON.stringify([id]));
      }
      const banner=$('#announcementBanner');
      if(banner) banner.classList.add('hidden');
    }

    function renderAnnouncementBanner(){
      const banner=$('#announcementBanner');
      if(!banner) return;
      const announcement = state.announcements.find(a=> a.is_banner);
      if(announcement && !isBannerDismissed(announcement.id)){
        $('#announcementBannerTitle').textContent = announcement.title;
        $('#announcementBannerBody').textContent = announcement.body;
        const detailBtn = $('#announcementDetailBtn');
        if(detailBtn){
          detailBtn.href = `/announcements.html?id=${encodeURIComponent(announcement.id)}`;
        }
        banner.dataset.announcementId = announcement.id;
        banner.classList.remove('hidden');
      }else{
        banner.classList.add('hidden');
      }
    }

    function supportSummary(label){
      switch(String(label||'').toLowerCase()){
        case 'plus': return '우선 지원 · 24시간 이내 응답';
        case 'pro': return '프리미엄 지원 · 12시간 이내 응답';
        default: return '이메일 지원 · 48시간 이내 응답';
      }
    }

    function renderBillingPlans(){
      const grid=$('#billingPlanGrid');
      if(grid){
        grid.innerHTML = state.plans.map(plan=>{
          const price = formatCurrencyKRW(plan.pricing?.monthly ?? 0);
          const usd = formatUSD(plan.pricing?.usdMonthly ?? 0);
          const storage = `프로젝트 ${formatBytes(plan.quotas?.projectBytes || 0)} · Cloud ${formatBytes(plan.quotas?.cloudBytes || 0)}`;
          const perks = plan?.perks || [];
          const isCurrent = String(state.session?.plan||'').toLowerCase() === String(plan.id||'').toLowerCase();
          const buttonLabel = isCurrent ? '현재 이용 중' : '구독 신청';
          return `<div class="planCard">
            <h4>${plan.label}</h4>
            <div class="muted">${plan.description || ''}</div>
            <div class="priceTag">${price}</div>
            <div class="priceSub">${usd || '&nbsp;'}</div>
            <div class="muted">${storage}</div>
            <ul>${perks.map(text=>`<li>${text}</li>`).join('')}</ul>
            <button class="btn ${isCurrent?'':'grad'} planSubscribeBtn" data-plan="${plan.id}" ${isCurrent?'disabled':''}>${buttonLabel}</button>
          </div>`;
        }).join('');
        $$('#billingPlanGrid .planSubscribeBtn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const planId = btn.dataset.plan;
            if(!planId) return;
            openSubscribeModal(planId);
          });
        });
      }

      const compare=$('#planComparisonTable');
      if(compare){
        const rows=[
          { label:'프로젝트 저장소', values:state.plans.map(p=>formatBytes(p.quotas?.projectBytes || 0)) },
          { label:'Cloud 저장소', values:state.plans.map(p=>formatBytes(p.quotas?.cloudBytes || 0)) },
          { label:'지원', values:state.plans.map(p=>supportSummary(p.label)) },
          { label:'월 요금', values:state.plans.map(p=>formatCurrencyKRW(p.pricing?.monthly ?? 0)) }
        ];
        compare.innerHTML = rows.map(row=>`<div class="planCompareRow"><strong>${row.label}</strong><div class="planCompareValues">${row.values.map((val,idx)=>`<span><b>${state.plans[idx].label}</b> ${val}</span>`).join('')}</div></div>`).join('');
      }

      $('#pricingUpdatedAt').textContent = state.catalogUpdatedAt ? `업데이트: ${new Date(state.catalogUpdatedAt).toLocaleString('ko-KR')}` : '업데이트 시각 불명';
    }

    function updateChipSelection(selector, attr, value){
      $$(selector+' .chipBtn').forEach(btn=> btn.classList.toggle('on', String(btn.dataset[attr])===String(value)));
    }

    function updateMethodSelection(method){
      $$('#paymentMethodCards .methodCard').forEach(card=> card.classList.toggle('on', card.dataset.method===method));
    }

    function updateSubscribeSummary(){
      const plan = state.plans.find(p => (p.id || '').toLowerCase() === String(subscribeState.planId || '').toLowerCase());
      if(!plan) return;
      const monthly = Number(plan.pricing?.monthly || 0);
      const months = subscribeState.cycle;
      let total = monthly * months;
      if(months === 12 && monthly > 0) total = monthly * 10; // two months free
      const discountedMonthly = months > 0 ? Math.round(total / months) : 0;
      const methodLabel = subscribeState.method === 'paypal' ? 'PayPal.Me' : subscribeState.method === 'proton' ? 'Proton Wallet' : '국내 계좌이체';
      const monthlyLine = (months === 12 && monthly > 0)
        ? `월 요금: ${formatCurrencyKRW(monthly)} → 12개월 선결제 시 <strong>${formatCurrencyKRW(discountedMonthly)}</strong> (2개월 무료)`
        : `월 요금: ${formatCurrencyKRW(monthly)}`;
      const totalLabel = total === 0 ? '무료' : '₩' + Number(total).toLocaleString('ko-KR');
      $('#subscribeSummary').innerHTML = `선택한 플랜: <strong>${plan.label}</strong><br>${monthlyLine}<br>총 결제 금액: <strong>${totalLabel}</strong><br>결제 수단: ${methodLabel}<br>송금 후 <strong>support@auditfy.app</strong> 으로 영수증을 전달해 주세요.`;
      $('#subscribeInstructions').innerHTML = PAYMENT_GUIDES[subscribeState.method] || '';
    }

    function setSubscribeStep(step){
      subscribeState.step = step;
      $$('.subStep').forEach(sec=> sec.classList.toggle('active', Number(sec.dataset.step)===step));
      $('#subscribeStepIndicator').textContent = `${step} / 3`;
      const backBtn = $('#subscribeBackBtn');
      const nextBtn = $('#subscribeNextBtn');
      const confirmBtn = $('#subscribeConfirmBtn');
      backBtn.classList.toggle('hidden', step===1);
      nextBtn.classList.toggle('hidden', step===3);
      confirmBtn.classList.toggle('hidden', step!==3);
      updateSubscribeSummary();
    }

    function openSubscribeModal(planId){
      subscribeState.planId = planId;
      const plan = state.plans.find(p => (p.id || '').toLowerCase() === String(planId || '').toLowerCase());
      subscribeState.cycle = plan && plan.pricing?.monthly ? 12 : 1;
      subscribeState.method = 'account';
      updateChipSelection('#billingCycleChips','cycle', subscribeState.cycle);
      updateMethodSelection(subscribeState.method);
      $('#subscribeModalTitle').textContent = `${plan?.label || '플랜'} 구독 신청`;
      setSubscribeStep(1);
      const modal = $('#subscribeModal');
      if(modal){
        modal.classList.add('open');
        modal.style.display='flex';
        modal.setAttribute('aria-hidden','false');
      }
    }

    function closeSubscribeModal(){
      const modal = $('#subscribeModal');
      if(modal){
        modal.classList.remove('open');
        modal.style.display='none';
        modal.setAttribute('aria-hidden','true');
      }
    }

    async function refreshUsage(){
      const usage = await Cloud.refreshUsage?.();
      if(usage?.ok){
        state.usage = { cloudBytes: usage.cloudBytes || 0, projBytes: usage.projBytes || 0 };
        renderUsage();
        snack('용량 정보를 새로고침했습니다.');
      }else{
        snack(usage?.error || '용량을 불러올 수 없습니다.');
      }
    }

    async function applyGiftCode(){
      const input=$('#giftCodeInput');
      const status=$('#giftCodeStatus');
      if(!input) return;
      const code=input.value.trim();
      if(!code){ snack('코드를 입력해주세요.'); return; }
      status.textContent='코드를 검증하는 중…';
      const res = await Cloud.redeemGiftCode?.(code);
      if(res?.ok){
        state.session.plan = res.plan || state.session.plan;
        state.session.planExpiresAt = res.planExpiresAt || state.session.planExpiresAt;
        renderDashboard();
        renderBillingPlans();
        status.textContent = '코드가 적용되었습니다.';
        input.value='';
        snack('기프트 코드가 적용되었습니다.');
      }else{
        status.textContent = res?.error || '코드를 적용할 수 없습니다.';
        snack(res?.error || '코드를 적용할 수 없습니다.');
      }
    }

    function openDeleteReasonModal(){
      const modal=$('#deleteReasonModal');
      const input=$('#deleteReasonInput');
      if(input) input.value = deleteState.reason || '';
      if(modal){
        modal.classList.add('open');
        modal.style.display='flex';
        modal.setAttribute('aria-hidden','false');
        setTimeout(()=> input?.focus(), 30);
      }
    }

    function closeDeleteReasonModal(){
      const modal=$('#deleteReasonModal');
      if(modal){
        modal.classList.remove('open');
        modal.style.display='none';
        modal.setAttribute('aria-hidden','true');
      }
    }

    function openDeleteConfirmModal(){
      const modal=$('#deleteConfirmModal');
      const preview=$('#deleteReasonPreview');
      if(preview){
        if(deleteState.reason?.trim()){
          preview.style.display='block';
          preview.innerHTML = `<strong>작성한 이유</strong><br>${deleteState.reason.replace(/\n/g,'<br>')}`;
        }else{
          preview.style.display='none';
        }
      }
      if(modal){
        modal.classList.add('open');
        modal.style.display='flex';
        modal.setAttribute('aria-hidden','false');
      }
    }

    function closeDeleteConfirmModal(){
      const modal=$('#deleteConfirmModal');
      if(modal){
        modal.classList.remove('open');
        modal.style.display='none';
        modal.setAttribute('aria-hidden','true');
      }
    }

    async function performDeleteAccount(){
      const res = await Cloud.deleteAccount?.();
      if(res?.ok){
        closeDeleteConfirmModal();
        snack('계정이 삭제되었습니다. 이용해 주셔서 감사합니다.');
        setTimeout(()=> location.href='/auth.html', 1200);
      }else{
        snack(res?.error || '계정을 삭제할 수 없습니다.');
      }
    }

    async function boot(){
      try{
        applyThemeFrom(getTheme());
        syncThemeButtons();
        Cloud.init?.();
        const sess = await Cloud.session?.();
        if(!sess){
          $('#statusText').textContent='로그인이 필요합니다';
          setTimeout(()=> location.replace('/auth.html?next=/account.html'), 600);
          return;
        }
        state.session = Object.assign({}, sess);
        $('#accountEmail').value = sess.email || '';
        $('#accountName').value = sess.name || '';
        $('#statusText').textContent='데이터 불러오는 중…';

        try{
          const catalog = await Cloud.planCatalog?.();
          if(catalog?.ok && Array.isArray(catalog.plans)){
            state.plans = catalog.plans;
            state.catalogUpdatedAt = catalog.updatedAt || null;
          }
        }catch(err){ console.warn('[Account] planCatalog 실패', err); }

        const usage = await Cloud.refreshUsage?.();
        if(usage?.ok){
          state.usage = { cloudBytes: usage.cloudBytes || 0, projBytes: usage.projBytes || 0 };
        }

        try{
          const announcements = await Cloud.listAnnouncements?.({ force:true });
          if(announcements?.ok && Array.isArray(announcements.announcements)){
            state.announcements = announcements.announcements;
          }
        }catch(err){ console.warn('[Account] announcements 실패', err); }

        renderDashboard();
        renderBillingPlans();
        renderAnnouncementBanner();
        $('#statusText').textContent='준비됨';
      }catch(err){
        console.error('[Account] boot 실패', err);
        $('#statusText').textContent='계정 정보를 불러오지 못했습니다.';
        snack('계정 정보를 불러오지 못했습니다. 다시 시도해주세요.');
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      $$('#menuRail .menuBtn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const panel = btn.dataset.panel;
          if(panel==='support'){
            window.open(SUPPORT_URL, '_blank');
            return;
          }
          activatePanel(panel);
        });
      });
      $('#refreshUsageBtn')?.addEventListener('click', refreshUsage);
      $('#viewPlansBtn')?.addEventListener('click', ()=>{
        activatePanel('billing');
        document.querySelector('[data-panel="billing"]').scrollIntoView({ behavior:'smooth', block:'start' });
      });
      $('#saveNameBtn')?.addEventListener('click', async ()=>{
        const name=$('#accountName').value.trim();
        if(!name){ snack('이름을 입력해주세요.'); return; }
        const res=await Cloud.updateProfile?.({ name });
        snack(res?.ok ? '이름을 저장했습니다.' : (res?.error || '저장에 실패했습니다.'));
        if(res?.ok) state.session.name = name;
      });
      $('#resetPasswordBtn')?.addEventListener('click', async ()=>{
        const res = await Cloud.requestPasswordReset?.({ email: state.session?.email });
        snack(res?.ok ? '재설정 메일을 발송했습니다.' : (res?.error || '메일 발송에 실패했습니다.'));
      });
      $('#logoutBtn')?.addEventListener('click', async ()=>{
        try{ await Cloud.logout?.(); }catch(err){ console.warn('[Account] 로그아웃 실패', err); }
        location.href='/auth.html';
      });
      $('#deleteAccountBtn')?.addEventListener('click', openDeleteReasonModal);
      $('#deleteReasonClose')?.addEventListener('click', closeDeleteReasonModal);
      $('#deleteReasonCancelBtn')?.addEventListener('click', closeDeleteReasonModal);
      $('#deleteReasonNextBtn')?.addEventListener('click', ()=>{
        const input=$('#deleteReasonInput');
        deleteState.reason = input?.value?.trim() || '';
        closeDeleteReasonModal();
        openDeleteConfirmModal();
      });
      $('#deleteConfirmClose')?.addEventListener('click', closeDeleteConfirmModal);
      $('#deleteBackBtn')?.addEventListener('click', ()=>{
        closeDeleteConfirmModal();
        openDeleteReasonModal();
      });
      $('#deleteLaterBtn')?.addEventListener('click', closeDeleteConfirmModal);
      $('#deleteConfirmBtn')?.addEventListener('click', performDeleteAccount);
      $('#deleteReasonModal')?.addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeDeleteReasonModal(); });
      $('#deleteConfirmModal')?.addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeDeleteConfirmModal(); });
      $('#giftCodeApplyBtn')?.addEventListener('click', applyGiftCode);
      $('#themeDarkBtn')?.addEventListener('click', ()=> setTheme('dark'));
      $('#themeLightBtn')?.addEventListener('click', ()=> setTheme('light'));
      $('#themeAutoBtn')?.addEventListener('click', ()=> setTheme('auto'));
      $('#subscribeModalClose')?.addEventListener('click', closeSubscribeModal);
      $('#subscribeModal')?.addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeSubscribeModal(); });
      $('#subscribeBackBtn')?.addEventListener('click', ()=> setSubscribeStep(Math.max(1, subscribeState.step-1)));
      $('#subscribeNextBtn')?.addEventListener('click', ()=> setSubscribeStep(Math.min(3, subscribeState.step+1)));
      $('#subscribeConfirmBtn')?.addEventListener('click', ()=>{ closeSubscribeModal(); snack('결제 후 support@auditfy.app 으로 영수증을 전달해 주세요.'); });
      $$('#billingCycleChips .chipBtn').forEach(btn=> btn.addEventListener('click', ()=>{ subscribeState.cycle = Number(btn.dataset.cycle || 1); updateChipSelection('#billingCycleChips','cycle', subscribeState.cycle); updateSubscribeSummary(); }));
      $$('#paymentMethodCards .methodCard').forEach(card=> card.addEventListener('click', ()=>{ subscribeState.method = card.dataset.method || 'account'; updateMethodSelection(subscribeState.method); updateSubscribeSummary(); }));
      $('#announcementDismiss')?.addEventListener('click', ()=>{
        const banner=$('#announcementBanner');
        const id=banner?.dataset?.announcementId;
        if(id) dismissBanner(id);
      });
      $('#announcementDismissBtn')?.addEventListener('click', ()=>{
        const banner=$('#announcementBanner');
        const id=banner?.dataset?.announcementId;
        if(id) dismissBanner(id);
      });

      boot();
    });
  </script>
</body>
</html>
