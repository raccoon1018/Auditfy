<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Auditfy • Projects</title>

<!-- 로고 전용 폰트 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0e13; --bg-elev:#121621; --line:#2a3242; --fg:#e6e9ef; --fg-weak:#aab1bf;
    --gradA:#5f7cff; --gradB:#9b7cff; --accent:#86e1ff; --danger:#ff6b6b; --ok:#86ffa8;
    --ltbarW: 48px;
  }
  body.theme-light{
    --bg:#f8fafc; --bg-elev:#ffffff; --line:#d7dbe3; --fg:#1c222b; --fg-weak:#556070;
    --gradA:#4d6bff; --gradB:#e77cff; --accent:#0ea5e9; --danger:#e11d48; --ok:#16a34a;
  }
  *{ box-sizing:border-box } html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif;
    display:flex; flex-direction:column; height:100vh; overflow:hidden;
  }

  /* 상단바 */
  .topbar{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
    gap:12px; padding:10px 14px; background:var(--bg-elev); border-bottom:1px solid var(--line);
  }
  .brand{ display:flex; align-items:center; gap:10px; user-select:none }
  .brand .logo{ font-family:'Montserrat',system-ui; font-weight:800; letter-spacing:.3px; font-size:20px; color:var(--fg) }
  .brand .chip{ font-size:11px; color:var(--fg-weak); border:1px solid var(--line); padding:2px 6px; border-radius:999px }
  .centerTitle{ text-align:center; display:flex; justify-content:center; align-items:center; gap:10px }
  #pageTitle{ font-weight:700 }
  .rightBtns{ display:flex; justify-content:flex-end; align-items:center; gap:8px }
  .iconBtn{ width:32px; height:32px; border-radius:999px; display:grid; place-items:center; cursor:pointer; border:1px solid var(--line); background:var(--bg-elev) }
  .iconBtn svg{ width:18px; height:18px; fill:none; stroke:var(--fg); stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round }

  /* 본문 */
  .main{ flex:1; min-height:0; display:grid; grid-template-columns: var(--ltbarW) 1fr; }
  .leftbar{ border-right:1px solid var(--line); background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.02)); display:flex; flex-direction:column; align-items:center; gap:8px; padding:8px 6px }
  .ltBtn{ width:34px; height:34px; border-radius:10px; border:1px solid var(--line); background:var(--bg-elev); display:grid; place-items:center; cursor:pointer }
  .ltBtn svg{ width:18px; height:18px; stroke:var(--fg) }
  .ltBtn.on{ outline:2px solid var(--gradA) }

  .content{ padding:16px; overflow:auto; position:relative }
  .toolbarRow{ display:flex; align-items:center; gap:10px; margin-bottom:12px; flex-wrap:wrap }
  .btn{ border:1px solid var(--line); background:var(--bg); color:var(--fg); padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn.grad{ background:linear-gradient(90deg,var(--gradA),var(--gradB)); border-color:transparent; color:#fff }
  .btnDanger{ color:var(--danger); border-color:var(--danger) }
  .muted{ color:var(--fg-weak) }

  .projGrid{ display:flex; gap:12px; flex-wrap:wrap; align-items:stretch; }
  .projGrid.list{ display:grid; gap:8px; }
  .cloudRow{ display:grid; grid-template-columns:1fr 140px 160px; align-items:center; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:var(--bg-elev); box-shadow:0 6px 16px rgba(0,0,0,.18); }
  .cloudRow .name{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .cloudRow .meta{ font-size:12px; color:var(--fg-weak); }
  .cloudRow .actions{ display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap; }
  .cloudRow.cloudHeader{ background:transparent; border-color:transparent; box-shadow:none; font-size:12px; color:var(--fg-weak); }
  .pCard{
    width:260px; background:var(--bg-elev); border:1px solid var(--line); border-radius:14px;
    padding:12px; display:flex; flex-direction:column; gap:8px; box-shadow:0 10px 34px rgba(0,0,0,.25)
  }
  .pTitle{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .pMeta{ font-size:12px; color:var(--fg-weak) }
  .pRow{ display:flex; gap:8px; margin-top:auto }
  .pRow .btn{ flex:1 }

  /* Cloud 파일 카드 */
  .fCard{
    width:220px; background:var(--bg-elev); border:1px solid var(--line); border-radius:14px;
    padding:12px; display:flex; flex-direction:column; gap:8px; box-shadow:0 10px 34px rgba(0,0,0,.2)
  }
  .fTitle{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .fMeta{ font-size:12px; color:var(--fg-weak) }
  .fRow{ display:flex; gap:8px; margin-top:auto }
  .fRow .btn{ flex:1 }

  .centerWrap{ min-height:calc(100% - 40px); display:grid; place-items:center }
  .centerCard{
    width:min(520px,90vw); background:var(--bg-elev); border:1px dashed var(--line); border-radius:16px; padding:18px;
    text-align:center; box-shadow:0 10px 34px rgba(0,0,0,.25)
  }

  .loadingOverlay{ position:absolute; inset:0; display:none; place-items:center; background:rgba(11,14,19,.66); backdrop-filter:blur(2px); border-radius:16px; z-index:120; }
  .loadingOverlay.open{ display:grid; }
  .loadingOverlay .inner{ display:flex; flex-direction:column; align-items:center; gap:12px; color:var(--fg); }
  .loadingOverlay .spinner{ width:44px; height:44px; border-radius:50%; border:3px solid rgba(134,225,255,.25); border-top-color:var(--accent); animation:spin .8s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  /* 하단바 */
  .bottombar{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-top:1px solid var(--line); background:var(--bg-elev); gap:12px }
  .status{ display:flex; align-items:center; gap:10px; color:var(--fg-weak) }

  /* 비로그인 안내 독 */
  .nudge{
    position:fixed; right:14px; bottom:58px; z-index:50;
    background:var(--bg-elev); border:1px solid var(--line); border-radius:14px; padding:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35); max-width:360px
  }
  .nudge .hd{ display:flex; justify-content:space-between; align-items:center; font-weight:800; margin-bottom:6px }
  .nudge .close{ border:none; background:transparent; color:var(--fg-weak); cursor:pointer }
  .hidden{ display:none !important }

  /* 공통 모달 */
  .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:200 }
  .modal.open{ display:grid }
  .card{ background:var(--bg-elev); border:1px solid var(--line); border-radius:16px; width:min(520px,94vw);
    box-shadow:0 20px 60px rgba(0,0,0,.5); overflow:hidden; animation:pop .16s ease-out }
  .hd{ padding:12px 16px; font-weight:800; border-bottom:1px dashed var(--line) }
  .bd{ padding:14px 16px; display:grid; gap:12px }
  .ft{ padding:12px 16px; border-top:1px dashed var(--line); display:flex; justify-content:flex-end; gap:8px }
  @keyframes pop{ from{ transform:translateY(6px); opacity:0 } to{ transform:none; opacity:1 } }

  /* 계정 모달 전용 */
  .nudgeIn{
    border:1px solid var(--line); border-radius:14px; padding:14px;
    background:
      linear-gradient(90deg, rgba(95,124,255,.12), rgba(155,124,255,.10));
  }
  .heroTitle{ font-size:18px; font-weight:800 }
  .heroSub{ color:var(--fg-weak); margin-top:2px }
  .btnRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap }
  .seg{ display:flex; border:1px solid var(--line); border-radius:10px; overflow:hidden }
  .seg button{ flex:1; padding:8px 10px; background:var(--bg); color:var(--fg); border:none; cursor:pointer }
  .seg button.on{ background:linear-gradient(90deg,var(--gradA),var(--gradB)); color:#fff; border-color:transparent }

  /* 스낵 */
  #snack{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%) translateY(14px); background:var(--bg-elev);
    border:1px solid var(--line); padding:8px 12px; border-radius:10px; opacity:0; transition:.2s; z-index:300 }
  #snack.show{ opacity:1; transform:translateX(-50%) }

  .in{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:var(--bg); color:var(--fg) }

  /* 컨텍스트 메뉴 */
  #ctx{ position:fixed; background:var(--bg-elev); border:1px solid var(--line); border-radius:10px; display:none; z-index:400; overflow:hidden; min-width:160px }
  #ctx.open{ display:block }
  #ctx .mi{ padding:8px 12px; cursor:pointer; border-bottom:1px dashed var(--line) }
  #ctx .mi:last-child{ border-bottom:none }
  #ctx .mi:hover{ background:var(--bg) }
  .hidden{ display:none !important; }

  .announceBanner{ border:1px solid var(--line); border-radius:14px; background:linear-gradient(120deg,rgba(95,124,255,0.18),rgba(155,124,255,0.12)); padding:14px 16px; display:flex; flex-direction:column; gap:8px; margin-bottom:18px; position:relative; }
  .announceBanner.hidden{ display:none; }
  .announceBanner h4{ margin:0; font-size:16px; }
  .announceBanner p{ margin:0; font-size:13px; color:var(--fg); }
  .announceBanner .bannerActions{ display:flex; gap:10px; flex-wrap:wrap; }
  .announceBanner .bannerActions .btn{ padding:8px 12px; }
  .announceBannerClose{ position:absolute; top:10px; right:10px; border:none; background:transparent; color:var(--fg-weak); cursor:pointer; font-size:18px; line-height:1; }
</style>
</head>
<body class="theme-dark">

<!-- 상단바 -->
<div class="topbar">
  <div class="brand"><div class="logo">Auditfy</div><div class="chip">alpha</div></div>
  <div class="centerTitle"><div id="pageTitle">내 프로젝트</div></div>
  <div class="rightBtns">
    <!-- 프로필 아이콘만 유지 -->
    <button id="avatarBtn" class="iconBtn" title="프로필">
      <svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/><path d="M4 20c0-3.5 3.5-6 8-6s8 2.5 8 6"/></svg>
    </button>
  </div>
</div>

<div class="main">
  <!-- 왼쪽 툴바: 요구대로 + 아래에 홈, 그리고 Cloud -->
  <div class="leftbar">
    <button id="btnNew" class="ltBtn" title="새 프로젝트">
      <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
    </button>
    <button id="btnHome" class="ltBtn on" title="Projects">
      <svg viewBox="0 0 24 24"><path d="M4 11L12 4l8 7v9H4z"/></svg>
    </button>
    <button id="btnCloud" class="ltBtn" title="Cloud">
      <svg viewBox="0 0 24 24"><path d="M6 16a4 4 0 0 1 2-7 5 5 0 0 1 9 2 3 3 0 0 1 1 6z"/></svg>
    </button>
  </div>

  <!-- 콘텐츠 -->
  <div class="content">
    <div id="announcementBanner" class="announceBanner hidden">
      <button class="announceBannerClose" id="announcementDismiss" aria-label="닫기">×</button>
      <h4 id="announcementBannerTitle">공지 제목</h4>
      <p id="announcementBannerBody">공지 내용</p>
      <div class="bannerActions">
        <a class="btn" id="announcementDetailBtn" href="/announcements.html" target="_blank" rel="noopener">자세히 보기</a>
        <button class="btn" id="announcementDismissBtn">다시 보지 않기</button>
      </div>
    </div>
    <!-- 상단 툴바(모드에 따라 변함) -->
    <div id="tbProjects" class="toolbarRow">
      <button id="btnRefresh" class="btn">새로고침</button>
      <span class="muted" id="uHint">상태: -</span>
    </div>

    <div id="tbCloud" class="toolbarRow" style="display:none">
      <button id="btnUp" class="btn" title="상위 폴더로">
        상위 폴더
      </button>
      <button id="btnViewMode" class="btn" title="보기 전환">목록 보기</button>
      <button id="btnMkDir" class="btn">폴더 생성</button>
      <button id="btnUpload" class="btn grad">파일 업로드…</button>
      <input id="inUpload" type="file" multiple style="display:none" />
      <span class="muted" id="cloudQuota" style="margin-left:auto"></span>
    </div>

    <div id="contentLoading" class="loadingOverlay">
      <div class="inner">
        <div class="spinner"></div>
        <div class="loadingText" id="loadingMessage">업로드 중…</div>
      </div>
    </div>

    <!-- 빈 상태 카드 -->
    <div id="emptyWrap" class="centerWrap hidden">
      <div class="centerCard">
        <h3 style="margin:0 0 6px 0">아직 프로젝트가 없습니다</h3>
        <div class="muted">왼쪽의 <b>＋</b> 버튼으로 새 프로젝트를 만들거나, 상단의 <b>프로필</b>에서 계정을 관리하세요.</div>
      </div>
    </div>

    <!-- Projects/Cloud 리스트 -->
    <div id="projGrid" class="projGrid"></div>
  </div>
</div>

<!-- 하단바 -->
<div class="bottombar">
  <div class="status">© Auditfy • Projects</div>
  <div class="status" id="statusText">준비됨</div>
</div>

<!-- 비로그인 안내 독(페이지 하단) -->
<div id="anonNudge" class="nudge hidden">
  <div class="hd">
    <div>비로그인 상태네요!</div>
    <button class="close" title="닫기" onclick="document.getElementById('anonNudge').classList.add('hidden')">✕</button>
  </div>
  <div class="muted" style="margin-bottom:8px">로그인하면 프로젝트를 클라우드에 저장·불러올 수 있어요.</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn grad" href="/auth.html?next=/projects.html">로그인</a>
    <a class="btn" href="/auth.html?next=/projects.html#signup">회원가입</a>
  </div>
</div>

<!-- 계정 모달 -->
<div id="accountModal" class="modal">
  <div class="card">
    <div class="hd">계정</div>
    <div class="bd" id="acctBody"><!-- JS로 렌더 --></div>
    <div class="ft"><button id="acctClose" class="btn">닫기</button></div>
  </div>
</div>

<!-- 확인/이름변경 모달 -->
<div id="confirmModal" class="modal">
  <div class="card" style="width:min(420px,92vw)">
    <div class="hd">확인</div>
    <div class="bd"><div id="confirmText">이 작업을 진행할까요?</div></div>
    <div class="ft"><button id="confirmNo" class="btn">취소</button><button id="confirmYes" class="btn grad">확인</button></div>
  </div>
</div>

<div id="renameModal" class="modal">
  <div class="card" style="width:min(420px,92vw)">
    <div class="hd">이름</div>
    <div class="bd"><input id="renameInput" class="in" placeholder="이름" /></div>
    <div class="ft"><button id="renameCancel" class="btn">취소</button><button id="renameOk" class="btn grad">저장</button></div>
  </div>
</div>

<!-- 미리듣기 모달 -->
<div id="previewModal" class="modal">
  <div class="card" style="width:min(560px,94vw)">
    <div class="hd">미리 듣기</div>
    <div class="bd">
      <div id="pvName" class="muted"></div>
      <audio id="pvAudio" controls style="width:100%"></audio>
    </div>
    <div class="ft"><button id="pvClose" class="btn">닫기</button></div>
  </div>
</div>

<!-- 컨텍스트 메뉴 -->
<div id="ctx"></div>

<div id="snack">OK</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="/cloud.js"></script>
<script>
/* ========= Boot & Theme ========= */
const $=(s,r=document)=>r.querySelector(s);
const snack=(t)=>{const el=$('#snack');el.textContent=t;el.classList.add('show');clearTimeout(snack._t);snack._t=setTimeout(()=>el.classList.remove('show'),1600);};
const BANNER_DISMISS_KEY='auditfy.banner.dismissed';
let bannerAnnouncement=null;
const THEME_KEY='auditfy.theme';
let sysMQ=window.matchMedia('(prefers-color-scheme: dark)');
function applyThemeFrom(value){
  document.body.classList.toggle('theme-light', value==='light' || (value==='auto' && !sysMQ.matches));
}
function setTheme(v){ localStorage.setItem(THEME_KEY, v); applyThemeFrom(v); markTheme(v); }
function getTheme(){ return localStorage.getItem(THEME_KEY) || 'dark'; }
function markTheme(v){ document.querySelectorAll('[data-theme]').forEach(b=>b.classList.toggle('on', b.dataset.theme===v)); }
sysMQ.addEventListener?.('change', ()=>{ if(getTheme()==='auto') applyThemeFrom('auto'); });

/* ========= Cloud init (with LocalFS fallback) ========= */
let CloudOK=false;
try{ Cloud.init?.(); CloudOK=true; }catch{ CloudOK=false; }
loadAnnouncementBanner();

let currentSession=null;
let sessionFetched=false;
let sessionFetchPromise=null;
async function ensureSession(force=false){
  if(force){
    sessionFetched=false;
    currentSession=null;
  }
  if(sessionFetched && !force) return currentSession;
  if(sessionFetchPromise) return sessionFetchPromise;
  sessionFetchPromise=(async()=>{
    let nextSession=null;
    if(CloudOK && typeof Cloud.session==='function'){
      try{
        nextSession=await Cloud.session();
      }catch(err){
        console.warn('[Auditfy] 세션 정보를 불러오지 못했습니다.', err);
      }
    }else{
      try{ nextSession=JSON.parse(localStorage.getItem('auditfy._session')||'null'); }
      catch{ nextSession=null; }
    }
    currentSession=nextSession||null;
    if(currentSession){
      try{ localStorage.setItem('auditfy._session', JSON.stringify(currentSession)); }
      catch{}
    }else{
      localStorage.removeItem('auditfy._session');
    }
    sessionFetched=true;
    sessionFetchPromise=null;
    return currentSession;
  })();
  return sessionFetchPromise;
}
function session(){ return currentSession; }

function isBannerDismissed(id){
  if(!id) return false;
  try{
    const arr = JSON.parse(localStorage.getItem(BANNER_DISMISS_KEY)||'[]');
    return Array.isArray(arr) && arr.includes(id);
  }catch{ return false; }
}

function rememberDismissed(id){
  if(!id) return;
  try{
    const arr = JSON.parse(localStorage.getItem(BANNER_DISMISS_KEY)||'[]');
    if(Array.isArray(arr)){
      if(!arr.includes(id)) arr.push(id);
      localStorage.setItem(BANNER_DISMISS_KEY, JSON.stringify(arr));
    }else{
      localStorage.setItem(BANNER_DISMISS_KEY, JSON.stringify([id]));
    }
  }catch{
    localStorage.setItem(BANNER_DISMISS_KEY, JSON.stringify([id]));
  }
}

async function loadAnnouncementBanner(){
  try{
    const res = await Cloud.listAnnouncements?.();
    if(res?.ok && Array.isArray(res.announcements)){
      bannerAnnouncement = res.announcements.find(a=> a.is_banner);
      renderAnnouncementBanner();
    }
  }catch(err){ console.warn('[Projects] announcement banner load failed', err); }
}

function renderAnnouncementBanner(){
  const banner=$('#announcementBanner');
  if(!banner){ return; }
  if(bannerAnnouncement && !isBannerDismissed(bannerAnnouncement.id)){
    $('#announcementBannerTitle').textContent = bannerAnnouncement.title;
    $('#announcementBannerBody').textContent = bannerAnnouncement.body;
    $('#announcementDetailBtn').href = `/announcements.html?id=${encodeURIComponent(bannerAnnouncement.id)}`;
    banner.dataset.announcementId = bannerAnnouncement.id;
    banner.classList.remove('hidden');
  }else{
    banner.classList.add('hidden');
  }
}

/* ========= Quotas / Format ========= */
const formatBytes=(b=0)=>{
  if(!Number.isFinite(b)) return '∞';
  if(b<1024) return b+'B';
  const u=['KB','MB','GB'];
  let i=-1; do{ b/=1024; i++; }while(b>=1024&&i<u.length-1);
  return b.toFixed(1)+u[i];
};
function planQuotas(plan){
  const MB=1024*1024;
  const p=(plan||'Free').toLowerCase();
  if(p==='unlimited') return {proj:Infinity, cloud:Infinity};
  if(p==='plus')      return {proj: 50*MB, cloud: 250*MB}; // 300MB
  if(p==='pro')       return {proj:100*MB, cloud: 400*MB}; // 500MB
  return {proj: 20*MB, cloud: 30*MB}; // Free (50MB)
}

/* ========= 프로젝트 저장소 (Project Store) ========= */
const ProjectsStore={
  async list(){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'로그인이 필요합니다.',items:[]};
    if(CloudOK && Cloud.projects?.list){
      try{
        const resp=await Cloud.projects.list();
        if(resp?.ok){
          const items=(resp.items||[]).map(it=>({
            id:it.id,
            displayName:it.displayName||it.name||'Untitled',
            name:it.displayName||it.name||'Untitled',
            updated:typeof it.updated==='number'?it.updated:Date.parse(it.updated)||Date.now(),
            size:it.size,
            fileName:it.fileName,
            filePath:it.filePath
          }));
          return {ok:true, items};
        }
        return {ok:false,error:resp?.error||'프로젝트 목록을 불러오지 못했습니다.'};
      }catch(e){ console.error(e); return {ok:false,error:'프로젝트 저장소에 연결할 수 없습니다.'}; }
    }
    return {ok:false,error:'프로젝트 저장소에 연결할 수 없습니다.', items:[]};
  },
  async create(name){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'로그인이 필요합니다.'};
    if(CloudOK && Cloud.projects?.create){
      try{
        const resp=await Cloud.projects.create({name});
        if(resp?.ok) return resp;
        return {ok:false,error:resp?.error||'프로젝트 생성에 실패했습니다.'};
      }catch(e){ console.error(e); return {ok:false,error:'프로젝트 저장소에 연결할 수 없습니다.'}; }
    }
    return {ok:false,error:'프로젝트 저장소에 연결할 수 없습니다.'};
  },
  async rename(id, newName){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'로그인이 필요합니다.'};
    if(CloudOK && Cloud.projects?.rename){
      try{
        const resp=await Cloud.projects.rename(id, newName);
        if(resp?.ok) return resp;
        return {ok:false,error:resp?.error||'프로젝트 이름을 변경할 수 없습니다.'};
      }catch(e){ console.error(e); return {ok:false,error:'프로젝트 저장소에 연결할 수 없습니다.'}; }
    }
    return {ok:false,error:'프로젝트 저장소에 연결할 수 없습니다.'};
  },
  async remove(id){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'로그인이 필요합니다.'};
    if(CloudOK && Cloud.projects?.remove){
      try{
        const resp=await Cloud.projects.remove(id);
        if(resp?.ok) return resp;
        return {ok:false,error:resp?.error||'프로젝트를 삭제할 수 없습니다.'};
      }catch(e){ console.error(e); return {ok:false,error:'프로젝트 저장소에 연결할 수 없습니다.'}; }
    }
    return {ok:false,error:'프로젝트 저장소에 연결할 수 없습니다.'};
  }
};

/* ========= LocalFS fallback for Cloud ========= */
function fsKey(email){ return `auditfy.fs.${email}`; }
function loadFS(email){
  try{
    return JSON.parse(localStorage.getItem(fsKey(email))||'{"root":{"type":"folder","name":"","children":{}}}');
  }catch{ return {"root":{"type":"folder","name":"","children":{}}}; }
}
function saveFS(email, data){ localStorage.setItem(fsKey(email), JSON.stringify(data)); }
function calcUsedBytes(node){
  let sum=0;
  function walk(n){ if(n.type==='file') sum+= (n.size||0); else Object.values(n.children||{}).forEach(walk); }
  walk(node.root); return sum;
}
function pathToNode(root, pathArr){
  let cur=root; for(const seg of pathArr){ if(!seg) continue; cur=(cur.children||{})[seg]; if(!cur) return null; }
  return cur;
}
function ensureUniqueName(parent, base){
  const names=new Set(Object.keys(parent.children||{}));
  if(!names.has(base)) return base;
  let i=1; while(names.has(`${base} (${i})`)) i++;
  return `${base} (${i})`;
}
function extOf(name){ const i=name.lastIndexOf('.'); return i>0? name.slice(i+1).toLowerCase() : ''; }
const audioExt = new Set(['mp3','wav','m4a','aac','ogg','flac','webm']);

const FS={
  async list(pathArr){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'login required', items:[]};
    if(CloudOK && Cloud.fs?.list) return Cloud.fs.list(pathArr);
    const db=loadFS(sess.email); const node=pathToNode(db.root, pathArr);
    if(!node||node.type!=='folder') return {ok:false,error:'not found',items:[]};
    const items=Object.values(node.children||{}).map(n=>({type:n.type,name:n.name,size:n.size||0,mime:n.mime||'',modified:n.modified||Date.now()}));
    return {ok:true, items};
  },
  async mkdir(pathArr, name){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'login required'};
    if(CloudOK && Cloud.fs?.mkdir) return Cloud.fs.mkdir(pathArr,name);
    const db=loadFS(sess.email); const node=pathToNode(db.root, pathArr);
    if(!node||node.type!=='folder') return {ok:false,error:'not found'};
    const nn=ensureUniqueName(node, name);
    node.children[nn]={type:'folder',name:nn,children:{},modified:Date.now()};
    saveFS(sess.email, db); return {ok:true,name:nn};
  },
  async upload(pathArr, file){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'login required'};
    if(CloudOK && Cloud.fs?.upload) return Cloud.fs.upload(pathArr,file);
    const db=loadFS(sess.email); const node=pathToNode(db.root, pathArr);
    if(!node||node.type!=='folder') return {ok:false,error:'not found'};
    const nn=ensureUniqueName(node, file.name);
    const buf = await file.arrayBuffer();
    node.children[nn]={type:'file',name:nn,size:buf.byteLength,mime:file.type||'',data:Array.from(new Uint8Array(buf)),modified:Date.now()};
    saveFS(sess.email, db); return {ok:true,name:nn,size:buf.byteLength};
  },
  async rename(pathArr, oldName, newName){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'login required'};
    if(CloudOK && Cloud.fs?.rename) return Cloud.fs.rename(pathArr,oldName,newName);
    const db=loadFS(sess.email); const node=pathToNode(db.root, pathArr);
    if(!node||node.type!=='folder') return {ok:false,error:'not found'};
    const cur=node.children[oldName]; if(!cur) return {ok:false,error:'not found'};
    const nn=ensureUniqueName(node,newName);
    delete node.children[oldName]; cur.name=nn; node.children[nn]=cur; cur.modified=Date.now();
    saveFS(sess.email, db); return {ok:true,name:nn};
  },
  async remove(pathArr, name){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'login required'};
    if(CloudOK && Cloud.fs?.remove) return Cloud.fs.remove(pathArr,name);
    const db=loadFS(sess.email); const node=pathToNode(db.root, pathArr);
    if(!node||node.type!=='folder') return {ok:false,error:'not found'};
    if(!node.children[name]) return {ok:false,error:'not found'};
    delete node.children[name]; saveFS(sess.email, db); return {ok:true};
  },
  async readFile(pathArr, name){
    const sess=await ensureSession(); if(!sess) return {ok:false,error:'login required'};
    if(CloudOK && Cloud.fs?.readFile) return Cloud.fs.readFile(pathArr,name);
    const db=loadFS(sess.email); const node=pathToNode(db.root, pathArr);
    const f = node?.children?.[name]; if(!f || f.type!=='file') return {ok:false,error:'not found'};
    const blob = new Blob([new Uint8Array(f.data||[])], {type: f.mime || 'application/octet-stream'});
    return {ok:true, blob, mime:f.mime||'', size:f.size||0, name:f.name};
  },
  async usage(){
    const sess=await ensureSession(); if(!sess) return {ok:false,cloud:0,proj:0};
    if(CloudOK && typeof Cloud.refreshUsage==='function'){
      const usage = await Cloud.refreshUsage();
      if(usage) return usage;
    }
    if(CloudOK && Cloud.usage?.cloudBytes) return Cloud.usage;
    const db=loadFS(sess.email); const cloud=calcUsedBytes(db);
    // 프로젝트 용량은 로컬에서는 추정만(프로젝트 개수 * 1KB)
    const proj = Math.max(0, readProjects().filter(p=>p.owner===sess.email).length * 1024);
    return {ok:true, cloudBytes:cloud, projBytes:proj};
  }
};

/* ========= UI State ========= */
let mode='projects'; // 'projects' | 'cloud'
let cwd=[];          // cloud: ['','folderA','subB'] → 경로
let cloudView = localStorage.getItem('auditfy.cloudView');
if(cloudView!=='grid' && cloudView!=='list') cloudView='list';
function updateCloudViewButton(){ const btn=$('#btnViewMode'); if(btn){ btn.textContent = cloudView==='grid' ? '목록 보기' : '카드 보기'; } }
function setCloudView(v){ cloudView = v==='list' ? 'list' : 'grid'; localStorage.setItem('auditfy.cloudView', cloudView); updateCloudViewButton(); if(mode==='cloud') render(); }
function setMode(m){
  mode=m;
  $('#btnHome').classList.toggle('on', m==='projects');
  $('#btnCloud').classList.toggle('on', m==='cloud');
  $('#tbProjects').style.display = (m==='projects')?'':'none';
  $('#tbCloud').style.display    = (m==='cloud')?'':'none';
  $('#pageTitle').textContent=(m==='projects')?'내 프로젝트':'Auditfy Cloud';
  render();
}

function showEmptyCard(title, desc){
  const wrap=$('#emptyWrap'); if(!wrap) return;
  const titleEl=wrap.querySelector('h3'); if(titleEl) titleEl.textContent=title;
  const descEl=wrap.querySelector('.muted'); if(descEl) descEl.innerHTML=desc;
  wrap.classList.remove('hidden');
}
function hideEmptyCard(){ const wrap=$('#emptyWrap'); if(wrap) wrap.classList.add('hidden'); }

function setLoadingOverlay(on, message){
  const overlay=$('#contentLoading'); if(!overlay) return;
  if(message){ const msg=overlay.querySelector('.loadingText'); if(msg) msg.textContent=message; }
  overlay.classList.toggle('open', !!on);
}

/* ========= Render ========= */
function fmtDate(ts){ const d=new Date(ts); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}.${p(d.getMonth()+1)}.${p(d.getDate())}`; }

async function render(){
  applyThemeFrom(getTheme());
  updateCloudViewButton();
  setLoadingOverlay(false);
  const sess=await ensureSession();
  $('#anonNudge').classList.toggle('hidden', !!sess);

  if(mode==='projects'){
    $('#pageTitle').textContent='내 프로젝트';
    const result = await renderProjects();
    if(!sess){
      $('#uHint').textContent='로그인하면 프로젝트 저장소를 이용할 수 있어요.';
      $('#statusText').textContent='프로젝트 저장소';
    }else if(result.error){
      $('#uHint').textContent=`상태: ${result.error}`;
      $('#statusText').textContent='프로젝트 저장소 오류';
    }else{
      $('#uHint').textContent=`프로젝트 ${result.count}개`; 
      $('#statusText').textContent='프로젝트 저장소';
    }
  }else{
    if(!sess){ if(mode!=='projects') setMode('projects'); return; }
    $('#pageTitle').textContent='Auditfy Cloud';
    const result = await renderCloud();
    if(result.error){
      $('#statusText').textContent='Cloud • 연결 실패';
      $('#uHint').textContent=result.error;
    }else{
      const pathStr='/' + cwd.filter(Boolean).join('/');
      $('#statusText').textContent=`Cloud • ${result.count}개 항목`;
      $('#uHint').textContent=`경로: ${pathStr || '/'}`;
    }
  }
}

async function renderProjects(){
  const sess=await ensureSession();
  const grid=$('#projGrid'); grid.innerHTML='';
  grid.classList.remove('list');

  if(!sess){
    showEmptyCard('로그인이 필요합니다', '로그인하면 프로젝트 저장소에 내 프로젝트를 저장하고 불러올 수 있어요.');
    return {count:0};
  }

  const resp=await ProjectsStore.list();
  if(!resp.ok){
    hideEmptyCard();
    snack(resp.error || '프로젝트 저장소에 연결할 수 없습니다.');
    const card=document.createElement('div'); card.className='centerCard';
    card.innerHTML=`<div class="muted">${resp.error || '프로젝트 저장소에 연결할 수 없습니다.'}</div>`;
    grid.appendChild(card);
    return {count:0, error:resp.error || '프로젝트 저장소에 연결할 수 없습니다.'};
  }

  const list=(resp.items||[]).slice().sort((a,b)=>(Number(b.updated)||0)-(Number(a.updated)||0));
  if(list.length===0){
    showEmptyCard('프로젝트 저장소가 비어 있어요', '프로젝트 저장소에 내 프로젝트를 저장해 보세요.');
    return {count:0};
  }

  hideEmptyCard();
  for(const p of list){
    const displayName = p.displayName || p.name || 'Untitled';
    const el=document.createElement('div');
    el.className='pCard';
    const updatedValue = Number(p.updated||0);
    const updated = updatedValue ? fmtDate(updatedValue) : '-';
    el.innerHTML=`
      <div class="pTitle" title="${displayName}">${displayName}</div>
      <div class="pMeta">수정: ${updated}</div>
      <div class="pRow">
        <button class="btn grad" data-act="open">열기</button>
        <button class="btn" data-act="rename">이름</button>
        <button class="btn btnDanger" data-act="del">삭제</button>
      </div>
    `;
    el.querySelector('[data-act="open"]').onclick=()=>openProject({id:p.id, name:displayName});
    el.querySelector('[data-act="rename"]').onclick=()=>renameProject({id:p.id, name:displayName});
    el.querySelector('[data-act="del"]').onclick=()=>deleteProject({id:p.id, name:displayName});
    grid.appendChild(el);
  }
  return {count:list.length};
}

async function renderCloud(){
  const sess=await ensureSession();
  const grid=$('#projGrid'); grid.innerHTML='';
  hideEmptyCard();
  grid.classList.toggle('list', cloudView==='list');
  updateCloudViewButton();

  const mkDirBtn=$('#btnMkDir');
  if(mkDirBtn){
    const disable = CloudOK && Cloud.fs && Cloud.fs.allowsFolders===false;
    mkDirBtn.disabled = !!disable;
    mkDirBtn.title = disable ? '현재 Cloud 백엔드에서는 폴더 생성이 지원되지 않습니다.' : '폴더 생성';
  }

  const usage = await FS.usage();
  const quotas = planQuotas(sess.plan||'Free');
  const used = usage.cloudBytes||0;
  $('#cloudQuota').textContent = `Cloud 사용량 ${formatBytes(used)} / ${formatBytes(quotas.cloud)}`;

  const res = await FS.list(cwd);
  if(!res.ok){
    snack(res.error || '목록을 불러오지 못했습니다.');
    showEmptyCard('Cloud에 연결할 수 없습니다', res.error || 'Cloud 목록을 불러오지 못했습니다.');
    return {count:0, error:res.error || '목록을 불러오지 못했습니다.'};
  }

  const items=(res.items||[]).slice().sort((a,b)=>{
    if(a.type!==b.type) return a.type==='folder'? -1 : 1;
    return a.name.localeCompare(b.name);
  });

  if(items.length===0){
    showEmptyCard('Cloud가 비어 있습니다', '파일을 업로드하거나 폴더를 생성해 보세요.');
    return {count:0};
  }

  hideEmptyCard();
  if(cloudView==='grid'){
    for(const it of items){
      const el=document.createElement('div');
      el.className='fCard'; el.dataset.name=it.name; el.dataset.type=it.type;
      el.innerHTML=`
        <div class="fTitle" title="${it.name}">${it.name}</div>
        <div class="fMeta">${it.type==='folder'?'폴더':'파일'} · ${it.type==='file'?formatBytes(it.size):''}</div>
        <div class="fRow">
          ${it.type==='folder'
            ? `<button class="btn grad" data-act="enter">열기</button><button class="btn" data-act="rename">이름</button><button class="btn btnDanger" data-act="del">삭제</button>`
            : `<button class="btn grad" data-act="dl">다운로드</button><button class="btn" data-act="rename">이름</button>${audioExt.has(extOf(it.name))?'<button class="btn" data-act="pv">미리듣기</button>':''}<button class="btn btnDanger" data-act="del">삭제</button>`}
        </div>
      `;
      el.addEventListener('contextmenu',(e)=>openCtx(e,it));
      el.querySelectorAll('[data-act]').forEach(b=> b.onclick=()=>cloudAction(it, b.dataset.act));
      grid.appendChild(el);
    }
  }else{
    const header=document.createElement('div'); header.className='cloudRow cloudHeader';
    header.innerHTML='<div>이름</div><div>정보</div><div style="text-align:right;">작업</div>';
    grid.appendChild(header);
    for(const it of items){
      const row=document.createElement('div');
      row.className='cloudRow'; row.dataset.name=it.name; row.dataset.type=it.type;
      const meta = it.type==='folder' ? '폴더' : `파일 · ${formatBytes(it.size)}`;
      row.innerHTML=`
        <div class="name" title="${it.name}">${it.name}</div>
        <div class="meta">${meta}</div>
        <div class="actions"></div>
      `;
      const actions=row.querySelector('.actions');
      const btnTemplates = it.type==='folder'
        ? [
            {label:'열기', act:'enter', accent:true},
            {label:'이름', act:'rename'},
            {label:'삭제', act:'del', danger:true}
          ]
        : [
            {label:'다운로드', act:'dl', accent:true},
            {label:'이름', act:'rename'},
            ...(audioExt.has(extOf(it.name))?[{label:'미리듣기', act:'pv'}]:[]),
            {label:'삭제', act:'del', danger:true}
          ];
      for(const btn of btnTemplates){
        const el=document.createElement('button');
        el.className='btn' + (btn.accent?' grad':'') + (btn.danger?' btnDanger':'');
        el.textContent=btn.label;
        el.dataset.act=btn.act;
        el.onclick=()=>cloudAction(it, btn.act);
        actions.appendChild(el);
      }
      row.addEventListener('contextmenu',(e)=>openCtx(e,it));
      grid.appendChild(row);
    }
  }

  return {count:items.length};
}

/* ========= Actions ========= */
function openProject(p){
  const params=new URLSearchParams();
  if(p?.id) params.set('pid', p.id);
  if(p?.name) params.set('title', p.name);
  const qs=params.toString();
  location.href='/index.html'+(qs?`?${qs}`:'');
}

// Auditfy 모달 유틸
function confirmModal(text){
  return new Promise(res=>{
    $('#confirmText').textContent=text||'이 작업을 진행할까요?';
    $('#confirmModal').classList.add('open');
    const yes=()=>{ cleanup(); res(true); };
    const no =()=>{ cleanup(); res(false); };
    function cleanup(){
      $('#confirmYes').removeEventListener('click', yes);
      $('#confirmNo').removeEventListener('click', no);
      $('#confirmModal').classList.remove('open');
    }
    $('#confirmYes').addEventListener('click', yes);
    $('#confirmNo').addEventListener('click', no);
  });
}
function renameModal(defaultName){
  return new Promise(res=>{
    const input=$('#renameInput'); input.value=defaultName||'';
    $('#renameModal').classList.add('open'); input.focus(); input.select();
    const ok =()=>{ close(); res(input.value.trim()||null); };
    const cancel=()=>{ close(); res(null); };
    function close(){
      $('#renameOk').removeEventListener('click', ok);
      $('#renameCancel').removeEventListener('click', cancel);
      $('#renameModal').classList.remove('open');
    }
    $('#renameOk').addEventListener('click', ok);
    $('#renameCancel').addEventListener('click', cancel);
  });
}

async function newProject(){
  const sess=await ensureSession();
  const input = await renameModal('새 프로젝트');
  if(input===null){ snack('생성을 취소했어요'); return; }
  const desired = (input.trim() || 'Untitled');

  if(sess){
    const created = await ProjectsStore.create(desired);
    if(!created?.ok){
      snack(created?.error || '프로젝트를 생성할 수 없습니다.');
      return;
    }
    const project = created.project || {};
    openProject({id:project.id, name:project.displayName || project.name || desired});
    return;
  }

  const projectId='p_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
  openProject({id:projectId, name:desired});
}

async function renameProject(p){
  const currentName = p.displayName || p.name || 'Untitled';
  const nv=await renameModal(currentName);
  if(nv===null) return;
  const text=nv.trim(); if(!text){ snack('이름을 입력해주세요'); return; }
  const res=await ProjectsStore.rename(p.id, text);
  if(!res.ok){ snack(res.error || '프로젝트 이름을 변경할 수 없습니다.'); return; }
  snack('이름을 변경했어요');
  render();
}
async function deleteProject(p){
  const label = p.displayName || p.name || '프로젝트';
  const ok=await confirmModal(`"${label}" 프로젝트를 삭제할까요? 이 작업은 되돌릴 수 없어요.`);
  if(!ok) return;
  const res=await ProjectsStore.remove(p.id);
  if(!res.ok){ snack(res.error || '프로젝트를 삭제할 수 없습니다.'); return; }
  snack('프로젝트를 삭제했어요');
  render();
}

/* ---- Cloud actions ---- */
async function cloudAction(it, act){
  if(act==='enter'){
    cwd=[...cwd, it.name]; render();
  }else if(act==='dl'){
    const r=await FS.readFile(cwd, it.name); if(!r.ok) return snack('다운로드 실패');
    const url=URL.createObjectURL(r.blob); const a=document.createElement('a');
    a.href=url; a.download=it.name; a.click(); URL.revokeObjectURL(url);
  }else if(act==='rename'){
    const nv=await renameModal(it.name); if(!nv) return;
    const r=await FS.rename(cwd, it.name, nv);
    if(r.ok){ snack('이름 변경'); render(); } else snack(r.error||'실패');
  }else if(act==='del'){
    const ok=await confirmModal(`"${it.name}"을(를) 삭제할까요?`);
    if(!ok) return;
    const r=await FS.remove(cwd, it.name);
    if(r.ok){ snack('삭제됨'); render(); } else snack(r.error||'실패');
  }else if(act==='pv'){
    // 오디오만
    const r=await FS.readFile(cwd, it.name); if(!r.ok) return snack('미리듣기 실패');
    $('#pvName').textContent=it.name;
    const url=URL.createObjectURL(r.blob);
    const a=$('#pvAudio'); a.src=url; a.play().catch(()=>{});
    $('#previewModal').classList.add('open');
  }
}

/* ---- Context menu ---- */
function openCtx(e, it){
  e.preventDefault();
  const ctx=$('#ctx'); ctx.innerHTML='';
  const add=(label,act)=>{ const d=document.createElement('div'); d.className='mi'; d.textContent=label; d.onclick=()=>{ ctx.classList.remove('open'); cloudAction(it,act); }; ctx.appendChild(d); };
  if(it.type==='folder'){
    add('열기','enter'); add('이름 변경','rename'); add('삭제','del');
  }else{
    add('다운로드','dl'); add('이름 변경','rename');
    if(audioExt.has(extOf(it.name))) add('미리듣기','pv');
    add('삭제','del');
  }
  const {clientX:x, clientY:y}=e; ctx.style.left=x+'px'; ctx.style.top=y+'px'; ctx.classList.add('open');
}
document.addEventListener('click',()=>$('#ctx').classList.remove('open'));

/* ========= Account Modal ========= */
async function renderAccountModal(){
  const sess=await ensureSession();
  const el=$('#acctBody');
  if(sess){
    el.innerHTML=`
      <div class="nudgeIn">
        <div class="heroTitle">${sess.name||'사용자'}</div>
        <div class="heroSub">${(sess.plan||'Free')} 플랜</div>
        <div class="btnRow">
          <a class="btn" href="/account.html#me">마이페이지</a>
          <button id="mLogout" class="btn btnDanger">로그아웃</button>
        </div>
      </div>
      <div class="row">
        <div>테마</div>
        <div class="seg">
          <button type="button" data-theme="dark">다크</button>
          <button type="button" data-theme="light">라이트</button>
          <button type="button" data-theme="auto">자동</button>
        </div>
      </div>
    `;
    $('#mLogout').onclick=async()=>{
      try{ await Cloud.logout?.(); }
      catch(err){ console.error('[Auditfy] 로그아웃 실패', err); }
      await ensureSession(true);
      snack('로그아웃되었습니다');
      $('#accountModal').classList.remove('open');
      setMode('projects');
    };
  }else{
    el.innerHTML=`
      <div class="nudgeIn">
        <div class="heroTitle">비회원 상태예요</div>
        <div class="heroSub">로그인하면 클라우드 저장과 다양한 혜택을 이용할 수 있어요.</div>
        <div class="btnRow">
          <a class="btn grad" href="/auth.html?next=/projects.html">로그인</a>
          <a class="btn" href="/auth.html?next=/projects.html#signup">회원가입</a>
        </div>
      </div>
      <div class="row">
        <div>테마</div>
        <div class="seg">
          <button type="button" data-theme="dark">다크</button>
          <button type="button" data-theme="light">라이트</button>
          <button type="button" data-theme="auto">자동</button>
        </div>
      </div>
    `;
  }
  const theme=getTheme(); markTheme(theme);
  el.querySelectorAll('[data-theme]').forEach(b=> b.onclick=()=>setTheme(b.dataset.theme));
}

/* ========= Events ========= */
$('#btnNew').onclick=newProject;
$('#btnHome').onclick=()=>setMode('projects');
$('#btnCloud').onclick=async()=>{
  const sess=await ensureSession();
  if(!sess){ location.href='/auth.html?next=/projects.html#cloud'; return; }
  setMode('cloud');
};
$('#btnRefresh').onclick=render;

$('#announcementDismiss')?.addEventListener('click', ()=>{
  if(bannerAnnouncement?.id) rememberDismissed(bannerAnnouncement.id);
  bannerAnnouncement=null;
  renderAnnouncementBanner();
});
$('#announcementDismissBtn')?.addEventListener('click', ()=>{
  if(bannerAnnouncement?.id) rememberDismissed(bannerAnnouncement.id);
  bannerAnnouncement=null;
  renderAnnouncementBanner();
});

$('#btnUp').onclick=()=>{
  if(cwd.length>0) { cwd=cwd.slice(0,-1); render(); }
};
$('#btnViewMode').onclick=()=> setCloudView(cloudView==='grid'?'list':'grid');
$('#btnMkDir').onclick=async()=>{
  const sess=await ensureSession(); if(!sess) return;
  const usage = await FS.usage(); const quotas=planQuotas(sess.plan||'Free');
  if(Number.isFinite(quotas.cloud) && (usage.cloudBytes||0) >= quotas.cloud){ snack('Cloud 용량 부족'); return; }
  const nv=await renameModal('새 폴더'); if(nv===null) return;
  const r=await FS.mkdir(cwd, nv||'새 폴더'); if(r.ok){ snack('폴더 생성'); render(); } else snack(r.error||'실패');
};
$('#btnUpload').onclick=()=>$('#inUpload').click();
$('#inUpload').addEventListener('change', async (e)=>{
  const sess=await ensureSession(); if(!sess) return;
  const files=[...e.target.files||[]]; if(!files.length) return;
  setLoadingOverlay(true, '업로드 중…');
  const usage = await FS.usage(); const quotas=planQuotas(sess.plan||'Free');
  let used=usage.cloudBytes||0;
  try{
    for(const f of files){
      if(Number.isFinite(quotas.cloud) && used + f.size > quotas.cloud){ snack(`용량 부족: ${f.name}`); continue; }
      const r=await FS.upload(cwd, f);
      if(r.ok){ used+= (r.size||f.size); }
      else if(r.error){ snack(r.error); }
    }
  }finally{
    setLoadingOverlay(false);
    e.target.value='';
    render();
  }
});

updateCloudViewButton();

$('#avatarBtn').onclick=async()=>{ await renderAccountModal(); $('#accountModal').classList.add('open'); };
$('#acctClose').onclick=()=>$('#accountModal').classList.remove('open');

$('#pvClose').onclick=()=>{ $('#previewModal').classList.remove('open'); const a=$('#pvAudio'); a.pause(); a.src=''; };

/* ========= Boot ========= */
(async function boot(){
  applyThemeFrom(getTheme());
  updateCloudViewButton();
  await ensureSession();
  // URL 해시 #cloud 로 진입 요청 처리
  if(location.hash==='#cloud' && session()){ setMode('cloud'); } else { setMode('projects'); }
})();
</script>

</body>
</html>
